<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>TTS streaming example</title>
</head>
<body>
    <button id="connect_btn" onclick="connect()">Connect to websocket...</button>
    <textarea id="prompt_area" style="width: 100%; height: 200px; margin: 15px 0; padding: 10px; box-sizing: border-box; resize: vertical;">The old woman sat on the park bench, not watching the children play, but the single, wilting dandelion pushing up through a crack in the concrete. It was the same dandelion she had spotted last year, and the year before. Each spring, it fought its way to the sun, a tiny, tenacious miracle. Today, however, the wind had changed. It was a sharp, late-autumn wind, and the dandelion's single, stubborn stalk was bent, almost broken, against the harsh gray. She reached out a trembling, gnarled finger and gently cupped the delicate head. She felt a familiar sadness, but also a strange sense of peace. The dandelion might not survive this cold snap, but it had lived its life, and for a few fleeting moments, under her care, it was safe. She closed her eyes, and the scent of damp earth and fading flowers filled her senses, a memory of seasons past, of life and loss, a story written not in words, but in the gentle, fleeting moments of a single, stubborn flower.</textarea>
    <button id="send_btn" onclick="request_tts(1, 0.05)" disabled>Enqueue text</button>


    <script>
        var ws = null;
        var audio_context = null;
        var queue = [];
        var start_time = 0;
        var is_playing = false;

        function init_audio_context() {
            audio_context = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
            start_time = audio_context.currentTime;
        }

        function enqueue(buffer) {
            var data = new Float32Array(buffer);
            
            var audio_buffer = audio_context.createBuffer(1, data.length, 24000);
            audio_buffer.getChannelData(0).set(data);
            queue.push(audio_buffer);
            
            if(!is_playing) { dequeue(); }
        }

        function dequeue() {
            if(queue.length == 0) {
                is_playing = false;
                return;
            }

            is_playing = true;

            var audio_buffer = queue.shift();
            var source = audio_context.createBufferSource();
            source.buffer = audio_buffer;
            
            source.connect(audio_context.destination);
            source.start(start_time);

            start_time += audio_buffer.duration;
            source.onended = dequeue;
        }

        function init_ws() {
            ws = new WebSocket("ws://localhost:8888");
            ws.binaryType = 'arraybuffer'; 

            ws.onopen = function() {
                console.log("[ws] connected");
                
                connect_btn.disabled = true;
                send_btn.disabled = false;
            };

            ws.onmessage = function(event) { enqueue(event.data) };
            ws.onclose = function() { console.log("[ws] closed"); };
        }

        function connect() {
            init_audio_context();
            init_ws();
        }

        function request_tts(speed, rms) {
            json = JSON.stringify({
                "text": prompt_area.value,
                "speed": speed,
                "threshold_rms": rms
            });
            ws.send(json);
            prompt_area.value = ""
        }
    </script>

</body>
</html>